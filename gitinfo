#!/usr/bin/env zsh
#
# git info
#    Shows information about a git repository
#    for the zsh prompt.
#

[ ! -d $HOME/.cache/git-info ] && mkdir -p $HOME/.cache/git-info
if ! git rev-parse --git-dir &>/dev/null; then
	UPSTREAM="no git"
else
	CACHEFILE=~/.cache/git-info/`pwd | tr '/' '='`
	if [ -f $CACHEFILE ] && [[ $(python2 -c 'import os.path,time;print "yes" if (time.time()-os.path.getmtime("'"$CACHEFILE"'"))/(60*60*24) > 2.0 else "no"') == "no" ]]; then
		UPSTREAM=`cat $CACHEFILE`
	else
		REMOTE=`git config --get remote.origin.url`
		if [ -z "$REMOTE" ]; then
			REMOTE="(local)$(basename `pwd`)"
		fi
		BRANCH="$(git rev-parse --abbrev-ref HEAD)"
		if [[ "${REMOTE:0:14}" == "git@github.com" ]]; then
			UPSTREAM="${REMOTE:15:-4}:$BRANCH"
		elif [[ "${REMOTE:0:19}" == "https://github.com/" ]]; then
			UPSTREAM="`echo ${REMOTE:19} | sed 's/.git//g'`:$BRANCH"
		elif [[ "${REMOTE:0:15}" == "git@git.mcbx.de" ]]; then
			UPSTREAM="git.mcbx.de/`echo ${REMOTE:16} | sed 's/.git//g'`:$BRANCH"
		elif [[ "${REMOTE:0:16}" == "git@repos.dma.do" ]]; then
			UPSTREAM="repos.dma.do/${REMOTE:17:-4}:$BRANCH"
		elif [[ "${REMOTE:0:31}" == "ssh://storage@abyss.mcbx.de:22/" ]]; then
			UPSTREAM="SparkleShare:${REMOTE:44}"
		elif [[ "${REMOTE:0:29}" == "ssh://aur@aur4.archlinux.org/" ]]; then
			UPSTREAM="AUR:${REMOTE:29:-4}"
		elif [[ "${REMOTE:0:28}" == "ssh://aur@aur.archlinux.org/" ]]; then
			UPSTREAM="AUR:${REMOTE:28:-4}"
		else
			UPSTREAM="${REMOTE}:$BRANCH"
		fi
		echo -n $UPSTREAM > $CACHEFILE
	fi
	# number of uncommited changes
	# do not cache this.
	CHANGES=`git status --short --ignore-submodules=all | wc -l | stripwhite`
	if [ $CHANGES -gt 0 ]
	then
		UPSTREAM="${UPSTREAM}:${CHANGES}"
	fi
fi
echo $UPSTREAM
